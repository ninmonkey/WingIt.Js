<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WingIt.Js - Seek Mouse Behavior</title>
    <link rel="stylesheet" href="./css/main.css" type="text/css">
</head>

<body>
    <!-- <section>
        <nav>
            <ul>
                <li><a href="./">Go Back</a></li>
                <li><a href="#" id="cmd-btn-toggle-grid-large">Large / Small</a></li>
            </ul>
        </nav>
    </section> -->
    <h1>Seek Mouse Behavior</h1>
    <section class="canvas-parent parent-context grid-small">

        <canvas id="canvas" width="800px" height="600px"></canvas>

    </section>

    <script type="module">
        import { randomInt, randomNumber, toDegrees, toRadians, randomAngle, randomAngleOffset } from './../../js/utils.js';
        import {
            Boid,
            BounceScreenEdge,
            debugLogBoidStates,
            TestIsOnScreen,
            Vector2,
            WrapScreenEdge,
        } from './../../js/boid.js';
        import { labelPoint, drawVector, drawVectorAngle } from './../../js/drawing.js';
        // globals
        const appConfig = {
            spawnCount: 7,
            spawnWithMass: false, // does random velocity takes radius into account?
            alwaysClearScreen: true,
        }
        window.bag ??= {}
        window.toDeg = toDegrees
        window.toRad = toRadians

        let entityList = Array.from( [] )

        const canvas = document.getElementById( "canvas" );
        const ctx = canvas.getContext( "2d" );
        const color_clear_canvas = "#464746";
        const color_boid_fill = "rgb(27, 151, 182)";
        const color_velocity = 'rgb(27 151 182 / .6)'
        const color_steer = 'rgb(160 100 100 / .6)'
        let start

        function drawCanvas () {
            if ( appConfig.alwaysClearScreen ) {
                ctx.clearRect( 0, 0, screen.width, screen.height )
            }

            for ( const ent of entityList ) {
                drawVectorAngle( ctx, ent.Position, toRadians( 45 ), 70, color_velocity ) // heading
                drawVectorAngle( ctx, ent.Position, toRadians( 45 ), 60, color_steer ) // heading
                ent.draw( ctx )
                // drawVector( ctx, { x: 10, y: 10  }, toRadians( -90 ), 10, 'green' )
            }
        }

        function updateGameStep ( timestamp ) {
            // todo: ensure timestep is increased by a fixed timestep to ensure stable physics simulations
            if ( start === undefined ) {
                start = timestamp;
            }
            const elapsed = timestamp - start;
            const timestepMod = ( elapsed ) / 1000

            for ( const b of entityList ) {
                b.update()
            }
            BounceScreenEdge( entityList, canvas )

            drawCanvas()
            // console.info(timestamp)
            requestAnimationFrame( updateGameStep )
        }

        function InitializePage () {
            // updateGameStep()
            let i
            const randAngle = randomAngle()
            const maxVel = 4

            for ( i = 0; i < appConfig.spawnCount; i++ ) {
                const b = new Boid()

                b.Radius = randomInt( 10, 30 )
                b.Position.fromCoord(
                    randomInt( 0, canvas.width ),
                    randomInt( 0, canvas.height ) )

                // b.Velocity.fromAngle( randomAngle(), 4 ).scale( 0.5 )
                b.Velocity.fromAngle( randomAngle(),
                    randomNumber( maxVel / 10, maxVel ) )

                if( appConfig.spawnWithMass ) {
                    if ( b.Radius > 20 ) { b.Velocity.scale( 0.3 ) } else { b.Velocity.scale( 4 ) }
                }

                b.Steer.fromAngle( toRadians( 0 ), 1 )
                b.Steer.fromCoord( 0, 0 )

                entityList.push( b )
            }
            console.info( `spawned ${i} boids` )
            debugLogBoidStates( entityList, 'table' )
            requestAnimationFrame( updateGameStep )
        }
        window.addEventListener( "load", InitializePage )
        canvas.addEventListener( 'mousemove', ( e ) => {
            const rect = canvas.getBoundingClientRect()
            const mouseX = e.clientX - rect.left
            const mouseY = e.clientY - rect.top
            // console.log( { mouseX, mouseY } )

            // console.info( { kind: 'mousemove', evt: e, mouseX, mouseY } )
            // for ( const b of entityList ) {
            //     const desired = new Vector2().fromCoord( mouseX, mouseY )
            //         .subtract( b.Position )
            //         .normalize()
            //         .scale( 0.5 ) // max speed

            //     const steer = desired.clone()
            //         .subtract( b.Velocity )
            //         .limit( 0.1 ) // max force

            //     b.Velocity.add( steer )
            //     // b.Velocity.limit( 3 ) // max speed
            // }
        } )

        window.bag.ctx = ctx
        window.bag.ents = entityList // might go out of sync if re-assigned
        console.trace( 'debug enabled globals: ', { bag } )
        console.info( 'Using Context Attrs', ctx.getContextAttributes() )
    </script>
</body>

</html>